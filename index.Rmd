---
title: "Algal Stream Condition Index "
output: 
  html_document:
    toc: true
    toc_float: true
self_contained: yes
runtime: shiny
---

<a href="https://github.com/fawda123/ASCIfigs/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

```{r setup, warning = F, message = F, cache = T, echo = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.pat = 'fig/')

# packages
library(tidyverse)
library(sf)
library(leaflet)
library(mapview)
library(shiny)
library(rsconnect)
library(gridExtra)

# data
data(ascidat)
data(ascithr)
data(suppdat)
data(psa)

## globals

# crs
prj <- '+proj=longlat +datum=WGS84 +no_defs'

# colors (boxplots, bi goals, scores)
ctcol <- RColorBrewer::brewer.pal(3, 'RdYlGn') %>% 
  rev
bicol <- ctcol[c(1, 3)]
sccol <- c('#d7191c', '#abd9e9', '#2c7bb6')

# palettes (scores, bi goals)
scpal <- colorNumeric(palette = sccol, na.color = 'yellow', domain = ascidat$scr)
bipal <- colorFactor(
  palette = bicol,
  na.color = 'yellow',
  levels = c('met', 'not met'))

# env vars to eval
evvar <- c('Phosphorus_as_P_mgPerL', 'Nitrogen_Total_mgPerL', 'XCDENMID', 'PCT_SAFN', 'SpecificConductivity_uSPercm', 'Temperature_Deg_C') 
names(evvar) <- c('Phosphorus (mg/L)', 'Total Nitrogen (mg/L)', '% Shading', '% Sands and Fines', 'Conductivity (mS/cm)', 'Temperature (C)')

# base theme
pbase <- theme_minimal(base_family = 'serif', base_size = 15) +
  theme(
    panel.border = element_rect(colour = 'black', fill = NA, size = 0.5),
    legend.position = 'top', 
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()
  )
```

```{r reactives}
# thresholds
thrsh <- reactive({
  
  # input
  thr <- input$thr 
  
  out <- ascithr %>% 
    filter(bigls %in% thr)
  
  return(out)
  
})

# asci data joined with thresholds, met/not met categories
# includes psa join
ascicat <- reactive({
  
  # input
  thrsh <- thrsh()
  
  # add threshold
  out <- ascidat %>% 
    left_join(thrsh, by = 'tax') %>% 
    mutate(
      scrcat = ifelse(scr < bival, 'not met', 'met')
    )
  
  return(out)
  
})

# map data, static
mapsta <- reactive({
  
  # input
  ascicat <- ascicat()

  # get index and taxa for mapping 
  # get most recent visit
  out <- ascicat %>% 
    filter(smps == 1) %>%
    filter(!is.na(scrcat)) %>% 
    group_by(site) %>% 
    filter(date %in% max(date)) %>% 
    ungroup %>% 
    dplyr::select(site, date, ind, tax, scr, scrcat, lon, lat) %>% 
    filter(!is.na(lon)|!is.na(lat)) %>% 
    mutate(
      lon = as.numeric(lon), 
      lat = as.numeric(lat)
      )
  
  return(out)
  
})

# map data, dynamic filtered by index and taxa
mapdyn <- reactive({
  
  # input
  indsel <- input$indsel
  taxsel <- input$taxsel
  mapsta <- mapsta()
  
  # filter by index and taxa
  out <- mapsta %>% 
    filter(ind %in% indsel) %>% 
    filter(tax %in% taxsel) %>% 
    st_as_sf(coords = c('lon', 'lat'), crs = prj)
  
  return(out)
  
})

# selected environmental variable, other indices, and asci data
cmbdat <- reactive({
  
  # input
  ascicat <- ascicat()
  evvr <- input$evvr
  olin <- input$olin

  # supp data to join
  suppjn <- suppdat %>% 
    filter(ind %in% olin)
  
  # new indices
  out <- ascicat %>% 
    rename(
      scrnew = scr,
      indnew = ind
      ) %>% 
    left_join(suppjn, by = 'sampleid') %>%
    mutate(
      scrdif = scrnew - scr
    ) %>% 
    select(one_of(c('sampleid', 'scrnew', 'indnew', 'ptile', 'bival', 'ind', 'tax', 'scr', 'scrdif', evvr)))
  
  return(out)
  
})
```

```{r}
selectInput('thr', 'Select biointegrity goal:', choices = unique(ascithr$bigls), selected = 'Ref10')
```

## Score distributions {.tabset}

### By Site types {.tabset .tabset-pills}

#### Scores

```{r}
# boxplot by site types
renderPlot({

  # input
  ascicat <- ascicat()

  # toplo 
  toplo <- ascicat %>% 
    filter(!is.na(sit2))

  # plot
  p <- ggplot(toplo, aes(x = sit2, y = scr)) + 
    geom_boxplot(outlier.size = 1, aes(fill = sit2), alpha = 0.7) + 
    geom_hline(aes(yintercept = bival), linetype = 'dashed', colour = 'tomato1', size = 1) +
    facet_grid(ind ~ tax) +
    scale_fill_manual(values = ctcol) +
    scale_y_continuous('Index Score') + 
    theme_minimal(base_family = 'serif', base_size = 16) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      axis.title.x = element_blank(), 
      panel.border = element_rect(colour = 'black', fill = NA, size = 0.5), 
      legend.position = 'none'
    ) 
  
  return(p)
  
}, height = 600)
```

#### Biointegrity goal

```{r}
# proportion met/not met by site type
renderPlot({
  
  # input
  ascicat <- ascicat()
  
  # get percent sites in each category by type
  toplo <- ascicat %>% 
    group_by(sit2, ind, tax, scrcat) %>% 
    summarise(
      n = length(scrcat)
    ) %>% 
    ungroup %>% 
    rename(Goal = scrcat) %>% 
    filter(!is.na(sit2)) %>% 
    filter(!is.na(Goal))
  
  p <- ggplot(toplo, aes(x = sit2, y = n, fill = Goal)) +
    geom_bar(stat = 'identity', position = 'fill', colour = 'grey', alpha = 0.8, width = 0.75) + 
    facet_grid(ind ~ tax) + 
    scale_y_continuous('Proportion', expand = c(0, 0)) +
    scale_fill_manual(values = bicol) + 
    theme_minimal(base_family = 'serif', base_size = 16) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      axis.title.x = element_blank(), 
      panel.border = element_rect(colour = 'black', fill = NA, size = 0.5), 
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      legend.position = 'top'
    ) 
  
  return(p)
  
}, height = 600)
```

### By PSA regions {.tabset .tabset-pills}

#### Scores

```{r}
# boxplot by PSA
renderPlot({

  # input
  ascicat <- ascicat()

  # toplo 
  toplo <- ascicat %>% 
    filter(!is.na(PSA6))

  # plot
  p <- ggplot(toplo, aes(x = PSA6, y = scr)) + 
    geom_boxplot(outlier.size = 1, alpha = 0.6, fill = 'lightblue') + 
    geom_hline(aes(yintercept = bival), linetype = 'dashed', colour = 'tomato1', size = 1) +
    facet_grid(ind ~ tax) +
    scale_y_continuous('Index Score') + 
    theme_minimal(base_family = 'serif', base_size = 16) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      axis.title.x = element_blank(), 
      panel.border = element_rect(colour = 'black', fill = NA, size = 0.5), 
      legend.position = 'none'
    ) 
  
  return(p)
  
}, height = 600)
```

#### Biointegrity goal

```{r}
# proportion met/not met by PSA
renderPlot({
  
  # input
  ascicat <- ascicat()
  
  # get percent sites in each category by PSA
  toplo <- ascicat %>% 
    group_by(PSA6, ind, tax, scrcat) %>% 
    summarise(
      n = length(scrcat)
    ) %>% 
    ungroup %>% 
    rename(Goal = scrcat) %>% 
    filter(!is.na(PSA6)) %>% 
    filter(!is.na(Goal))
  
  p <- ggplot(toplo, aes(x = PSA6, y = n, fill = Goal)) +
    geom_bar(stat = 'identity', position = 'fill', colour = 'grey', alpha = 0.8, width = 0.75) + 
    facet_grid(ind ~ tax) + 
    scale_y_continuous('Proportion', expand = c(0, 0)) +
    scale_fill_manual(values = bicol) + 
    theme_minimal(base_family = 'serif', base_size = 16) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      axis.title.x = element_blank(), 
      panel.border = element_rect(colour = 'black', fill = NA, size = 0.5), 
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      legend.position = 'top'
    ) 
  
  return(p)
  
}, height = 600)

```

### Static Maps {.tabset .tabset-pills}

#### Scores

```{r}
renderPlot({
  
  # input
  mapsta <- mapsta()

  p <- ggplot(mapsta) + 
    geom_sf(data = psa, fill = NA) +
    geom_point(aes(x = lon, y = lat, colour = scr), alpha = 0.7, size = 1.5) +
    facet_grid(ind ~ tax) +
    coord_sf() +
    scale_colour_gradientn('ASCI score', colors = sccol) +
    theme_void(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      panel.grid.major = element_line(colour = 'transparent'), 
      panel.grid.minor = element_line(colour = 'transparent')
    ) +
    guides(colour = guide_colourbar(barheight = 0.5, barwidth = 10))

  return(p)
  
}, height = 800)
```

#### Biointegrity goal

```{r}
renderPlot({
  
  # input
  mapsta <- mapsta()

  p <- ggplot(mapsta) + 
    geom_sf(data = psa, fill = NA) +
    geom_point(aes(x = lon, y = lat, colour = scrcat), alpha = 0.7, size = 1.5) +
    facet_grid(ind ~ tax) +
    coord_sf() +
    scale_colour_manual('Biointegrity goal', values = bicol) + 
    theme_void(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      panel.grid.major = element_line(colour = 'transparent'), 
      panel.grid.minor = element_line(colour = 'transparent')
    )
  
  return(p)
  
}, height = 800)
```

### Dynamic Maps {.tabset .tabset-pills}

```{r}
column(12, 
  
       column(6, 
              selectInput('indsel', 'Select index:', choices = c('O/E', 'MMI', 'O/E + MMI'))
       ),
       
       column(6, 
              selectInput('taxsel', 'Select group:', choices = list('Diatom', 'Soft-bodied', 'Hybrid'))
       )
  
)
```

#### Scores

```{r}
# scrmap
output$scrmap <- renderLeaflet({
  
  # input
  mapdyn <- mapdyn()
  
  mapview(psa, fill = F, label = psa$PSA6, homebutton = F) %>% 
    .@map %>% 
    removeMouseCoordinates() %>%
    addCircleMarkers(
      data = mapdyn, 
      layerId = ~site,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~scpal(scr),
      radius=5, 
      weight = 1,
      fillOpacity = 1,
      label = ~paste0(site, ' (', date, '): ', round(scr, 2), ' (', scrcat, ')')
    )  %>% 
    addLegend("topright", pal = scpal, values = mapdyn$scr,
                title = "Score",
                opacity = 1
      )
  
  })

leafletOutput('scrmap', height = 700)
```

#### Biointegrity goal

```{r}

# met/not met map
output$catmap <- renderLeaflet({

  # input
  mapdyn <- mapdyn()

  mapview(psa, fill = F, label = psa$PSA6, homebutton = F) %>%
    .@map %>%
    removeMouseCoordinates() %>%
    addCircleMarkers(
      data = mapdyn,
      layerId = ~site,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~bipal(scrcat),
      radius=5,
      weight = 1,
      fillOpacity = 1,
      label = ~paste0(site, ' (', date, '): ', round(scr, 2), ' (', scrcat, ')')
    ) %>% 
    addLegend("topright", pal = bipal, values = mapdyn$scrcat,
                title = "Goal",
                opacity = 1
      )

  })

leafletOutput('catmap', height = 700)
```

## Relationships with environmental variables

```{r}
selectInput('evvr', 'Select environmental variable:', choices = evvar)
```

```{r}
renderPlot({

  # input
  cmbdat <- cmbdat()
  evvr <- input$evvr
  
  # evvr name
  xlab <- names(evvar[evvar %in% evvr])
  
  ## prep plot data from combined object

  # old indices
  toplo_old <- suppdat 
  
  pold <- ggplot(toplo_old, aes_string(x = evvr, y = 'scr')) +
    geom_point(alpha = 0.7, size = 1.3) +
    geom_smooth(method = 'lm', se = FALSE) +
    facet_wrap( ~ ind, ncol = 4) +
    scale_y_continuous('ASCI score', expand = c(0, 0)) +  
    scale_x_continuous(xlab) +
    pbase
  
  # new indices
  toplo_new <- cmbdat

  pnew <- ggplot(toplo_new, aes_string(x = evvr, y = 'scr')) +
    geom_point(alpha = 0.7, size = 1.3) +
    geom_smooth(method = 'lm', se = FALSE) +
    geom_hline(aes(yintercept = bival), linetype = 'dashed', colour = 'tomato1', size = 1) +
    facet_grid(indnew ~ tax) +
    scale_y_continuous('ASCI score', expand = c(0, 0)) +  
    scale_x_continuous(xlab) +
    pbase

  if(evvr %in% c('Phosphorus_as_P_mgPerL', 'Nitrogen_Total_mgPerL')){
    pold <- pold + scale_x_log10(xlab)   
    pnew <- pnew + scale_x_log10(xlab) 
  }
  
  grid.arrange(pold, pnew, ncol = 1, heights = c(0.5, 1))
  
}, height = 700)
```

## Comparisons with existing indices

```{r}
selectInput('olin', 'Select index for comparison:', choices = c('CSCI', 'D18', 'S2', 'H20'))
```

```{r}
renderPlot({
  
  # input
  cmbdat <- cmbdat()
  olin <- input$olin

  lms <- c(0, 1.6)
  xlab <- paste(olin, 'Score')
  ylab <- paste('ASCI -', olin, 'Score')

  toplo <- cmbdat %>% 
    filter(!is.na(scr))

  p1 <- ggplot(toplo, aes(x = scr, y = scrnew)) +
    geom_point(alpha = 0.6, size = 1) +
    geom_abline(intercept = 0, slope = 1, linetype = 'dashed') +
    geom_smooth(method = 'lm', se = F) +
    facet_grid(indnew ~ tax) +
    scale_y_continuous('ASCI Score', limits = lms) +
    scale_x_continuous(xlab, limits = lms) +
    pbase 

  p2 <- ggplot(toplo, aes(x = scr, y = scrdif)) +
    geom_point(alpha = 0.6, size = 1) +
    geom_hline(yintercept = 0, linetype = 'dashed') +
    geom_smooth(method = 'lm', se = F) +
    facet_grid(indnew ~ tax) +
    scale_y_continuous(ylab) +
    scale_x_continuous(xlab, limits = lms) +
    pbase

  grid.arrange(p1, p2, ncol = 1)
  
}, height = 950)
```

